<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multiplayer Dots</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #111;
      font-family: system-ui, sans-serif;
      color: #fff;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 10;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <div id="info">
    Multiplayer Dots<br />
    Move: WASD or Arrow Keys
  </div>
  <canvas id="game"></canvas>

  <!-- socket.io client script served by the server -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    const socket = io(); // connects to same origin where server is hosted

    const players = {}; // { id: { x, y, color } }
    let myId = null;

    socket.on("connect", () => {
      myId = socket.id;
      console.log("My ID:", myId);
    });

    socket.on("currentPlayers", (serverPlayers) => {
      for (const id in serverPlayers) {
        players[id] = serverPlayers[id];
      }
    });

    socket.on("newPlayer", ({ id, data }) => {
      players[id] = data;
    });

    socket.on("playerMoved", ({ id, data }) => {
      players[id] = data;
    });

    socket.on("playerDisconnected", (id) => {
      delete players[id];
    });

    const speed = 4;
    const input = { up: false, down: false, left: false, right: false };

    window.addEventListener("keydown", (e) => {
      if (e.key === "w" || e.key === "ArrowUp") input.up = true;
      if (e.key === "s" || e.key === "ArrowDown") input.down = true;
      if (e.key === "a" || e.key === "ArrowLeft") input.left = true;
      if (e.key === "d" || e.key === "ArrowRight") input.right = true;
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "w" || e.key === "ArrowUp") input.up = false;
      if (e.key === "s" || e.key === "ArrowDown") input.down = false;
      if (e.key === "a" || e.key === "ArrowLeft") input.left = false;
      if (e.key === "d" || e.key === "ArrowRight") input.right = false;
    });

    function gameLoop() {
      // Update my position
      if (myId && players[myId]) {
        const me = players[myId];
        if (input.up) me.y -= speed;
        if (input.down) me.y += speed;
        if (input.left) me.x -= speed;
        if (input.right) me.x += speed;

        // Boundaries
        me.x = Math.max(15, Math.min(canvas.width - 15, me.x));
        me.y = Math.max(15, Math.min(canvas.height - 15, me.y));

        // Send to server
        socket.emit("playerMove", { x: me.x, y: me.y });
      }

      // Draw
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const id in players) {
        const p = players[id];
        ctx.beginPath();
        ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
        ctx.fillStyle = p.color || "#fff";
        ctx.fill();

        if (id === myId) {
          ctx.font = "12px system-ui";
          ctx.fillStyle = "#fff";
          ctx.fillText("You", p.x - 12, p.y - 20);
        }
      }

      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>
